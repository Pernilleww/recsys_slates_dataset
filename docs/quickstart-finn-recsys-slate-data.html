---

title: Quick start with the FINN.no recsys slate dataset [![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/finn-no/recsys-slates-dataset/blob/master/quickstart-finn-recsys-slate-data.ipynb)


keywords: fastai
sidebar: home_sidebar



nb_path: "quickstart-finn-recsys-slate-data.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: quickstart-finn-recsys-slate-data.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install-the-recsys_slates_dataset-pip-package">Install the recsys_slates_dataset pip package<a class="anchor-link" href="#Install-the-recsys_slates_dataset-pip-package"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install recsys_slates_dataset -q
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Download-and-load-dataloaders-that-are-ready-to-use">Download and load dataloaders that are ready to use<a class="anchor-link" href="#Download-and-load-dataloaders-that-are-ready-to-use"> </a></h2><p>It is possible to directly load the dataset as a pytorch dataloader which includes the same dataset splits etc as in the original paper.
Use the <a href="/recsys_slates_dataset/dataset_torch.html#load_dataloaders"><code>load_dataloaders</code></a> function in the <a href="/recsys_slates_dataset/dataset_torch.html"><code>dataset_torch</code></a> module. It has the following options:</p>
<table>
<thead><tr>
<th>Argument</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>batch_size</td>
<td style="text-align:right">Number of unique users sampled in each batch</td>
</tr>
<tr>
<td>split_trainvalid</td>
<td style="text-align:right">Ratio of full dataset dedicated to train <br> (val/test is split evenly among the rest)</td>
</tr>
<tr>
<td>t_testsplit</td>
<td style="text-align:right">For users in valid and test, <br> how many interactions should belong to training set</td>
</tr>
<tr>
<td>sample_uniform_action</td>
<td style="text-align:right">If this is True, the exposures in the dataset <br> are sampled as in the <code>all-item likelihood</code> (see paper)</td>
</tr>
</tbody>
</table>
<p>The outputs of the function are <code>ind2val</code>, <code>itemattr</code> and a dictionary with pytorch dataloaders for training, validation and test.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">recsys_slates_dataset</span> <span class="kn">import</span> <span class="n">dataset_torch</span>
<span class="n">ind2val</span><span class="p">,</span> <span class="n">itemattr</span><span class="p">,</span> <span class="n">dataloaders</span> <span class="o">=</span> <span class="n">dataset_torch</span><span class="o">.</span><span class="n">load_dataloaders</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="s2">&quot;dat&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dictionary containing the dataloaders:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataloaders</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-07-03 21:13:13,672 Download data if not in data folder..
2021-07-03 21:13:13,676 Downloading data.npz
2021-07-03 21:13:13,691 Downloading ind2val.json
2021-07-03 21:13:13,694 Downloading itemattr.npz
2021-07-03 21:13:13,698 Done downloading all files.
2021-07-03 21:13:13,707 Load data..
2021-07-03 21:13:53,963 Loading dataset with slate size=torch.Size([2277645, 20, 25]) and uniform candidate sampling=False
2021-07-03 21:13:54,179 In train: num_users: 2277645, num_batches: 2225
2021-07-03 21:13:54,187 In valid: num_users: 113882, num_batches: 112
2021-07-03 21:13:54,192 In test: num_users: 113882, num_batches: 112
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Dictionary containing the dataloaders:
{&#39;train&#39;: &lt;torch.utils.data.dataloader.DataLoader object at 0x7fcd88da59a0&gt;, &#39;valid&#39;: &lt;torch.utils.data.dataloader.DataLoader object at 0x7fcd88dc6e80&gt;, &#39;test&#39;: &lt;torch.utils.data.dataloader.DataLoader object at 0x7fcd88dc6550&gt;}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Batches">Batches<a class="anchor-link" href="#Batches"> </a></h3><p>The batches are split by userId and provides the necessary information for training. We will explain each element below:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloaders</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]))</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>userId torch.Size([1024])
click torch.Size([1024, 20])
click_idx torch.Size([1024, 20])
slate_lengths torch.Size([1024, 20])
slate torch.Size([1024, 20, 25])
interaction_type torch.Size([1024, 20])
mask_type torch.Size([1024, 20])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Interaction-data-(data.npz)">Interaction data (<code>data.npz</code>)<a class="anchor-link" href="#Interaction-data-(data.npz)"> </a></h3><p>The dataset consist of 2.2M unique users that have interacted up to 20 times with the internet platform platform, and has been exposed to up to 25 items at each interaction.
<code>data.npz</code> contains all the slate and click data, and the two main arrays are <code>click</code> and <code>slate</code>. 
The convention of the dimension of the arrays are that the first dimension is per user, second dimension is time and third dimension is the presented slate.
The full description of all array are as follows:</p>
<table>
<thead><tr>
<th>Name</th>
<th style="text-align:center">Dimension</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>slate</td>
<td style="text-align:center">[userId, interaction num, slate pos]</td>
<td style="text-align:right">the presented slates to the users;</td>
</tr>
<tr>
<td>click</td>
<td style="text-align:center">[userId, interaction num]</td>
<td style="text-align:right">items clicked by the users in each slate</td>
</tr>
<tr>
<td>interaction_type</td>
<td style="text-align:center">[userId, interaction num]</td>
<td style="text-align:right">type of interaction the user had with the platform (search or recommendation)</td>
</tr>
<tr>
<td>click_idx</td>
<td style="text-align:center">[userId, interaction num]</td>
<td style="text-align:right">Auxillary data: The position of the click in the <code>slate</code> dataframe (integer from 0-24). <br> Useful for e.g. categorical likelihoods</td>
</tr>
<tr>
<td>slate_lengths</td>
<td style="text-align:center">[userId, interaction num]</td>
<td style="text-align:right">Auxillary data: the actual length of the slate. <br> Same as 25-<code>"number of pad index in action"</code></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dat</span> <span class="o">=</span> <span class="n">dataloaders</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># Print dimensions of all arrays:</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> : </span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">val</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>userId : 	 torch.Size([2277645])
click : 	 torch.Size([2277645, 20])
click_idx : 	 torch.Size([2277645, 20])
slate_lengths : 	 torch.Size([2277645, 20])
slate : 	 torch.Size([2277645, 20, 25])
interaction_type : 	 torch.Size([2277645, 20])
mask_type : 	 torch.Size([2277645, 20])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Example:-Get-one-interaction">Example: Get one interaction<a class="anchor-link" href="#Example:-Get-one-interaction"> </a></h4><p>Get the presented slate + click for user 5 at interaction number 3</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Slate:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;slate&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Click:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Type of interaction: (1 implies search, see ind2val file)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;interaction_type&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Slate:
tensor([     1, 638995, 638947, 638711, 637590, 637930, 638894,      0,      0,
             0,      0,      0,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      0,      0])
 
Click:
tensor(637590)
Type of interaction: (1 implies search, see ind2val file)
tensor(1)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>From the above extraction we can see that user 5 at interaction number 3 was presented with a total of 7 items: 6 "real" items and the "no-click" item that has index 1. The remaining positions in the array is padded with the index 0.
The "no-click" item is always present in the slates, as the user has the alternative not to click on any of the presented items in the slate.
Further, we see that the user clicked on the 4'th item in the slate.
The slate length and the click position can be found by the following auxillary arrays:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Click_idx:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;click_idx&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Slate lengths:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;slate_lengths&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Click_idx:
tensor(4)
Slate lengths:
tensor(7)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Index-to-item-(ind2val.json)">Index to item (<code>ind2val.json</code>)<a class="anchor-link" href="#Index-to-item-(ind2val.json)"> </a></h3><p>This files contains mapping from indices to values for the attributes category and interaction_type.</p>
<table>
<thead><tr>
<th>Name</th>
<th style="text-align:center">Length</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>category</td>
<td style="text-align:center">290</td>
<td style="text-align:right">Mapping from the category index to a text string that describes the category. <br> The category value is a text string that describes the category and location of the group</td>
</tr>
<tr>
<td>interaction_type</td>
<td style="text-align:center">3</td>
<td style="text-align:right">Indices of whether the presented slate originated from search or recommendations</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Example-ind2val">Example <code>ind2val</code><a class="anchor-link" href="#Example-ind2val"> </a></h4><p>We print out the first elements of each index.
For example, we see that category 3 is "BAP,antiques,Trøndelag" which implies the category contains antiques sold in the county of Trøndelag.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">ind2val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> first entries:&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
      <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> 
category first entries:
0: PAD
1: noClick
2: &lt;UNK&gt;
3: BAP,antiques,Trøndelag
4: MOTOR,,Sogn og Fjordane
 
interaction_type first entries:
1: search
2: rec
0: &lt;UNK&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Item-attributes-(itemattr.npz)">Item attributes (<code>itemattr.npz</code>)<a class="anchor-link" href="#Item-attributes-(itemattr.npz)"> </a></h3><p>A numpy array that encodes the category of each item.</p>
<table>
<thead><tr>
<th>Name</th>
<th style="text-align:center">Dimension</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>category</td>
<td style="text-align:center">[itemId]</td>
<td style="text-align:right">The group that each item belong to</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">itemattr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The full dictionary:&quot;</span><span class="p">)</span>
<span class="n">itemattr</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>category : (1311775,)

The full dictionary:
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;category&#39;: array([  0.,   1.,   2., ..., 289., 289., 289.])}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Example-itemattr">Example <code>itemattr</code><a class="anchor-link" href="#Example-itemattr"> </a></h4><p>Get the category of the clicked item above (from user 5, interaction number 3)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Find the itemId that were click by user 5 in interaction 3:&quot;</span><span class="p">)</span>
<span class="n">itemId</span> <span class="o">=</span> <span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;itemId: </span><span class="si">{</span><span class="n">itemId</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Find the category index of that item in itemattr:&quot;</span><span class="p">)</span>
<span class="n">cat_idx</span> <span class="o">=</span> <span class="n">itemattr</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">][</span><span class="n">itemId</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Category index: </span><span class="si">{</span><span class="n">cat_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finally, find the category name by using ind2val:&quot;</span><span class="p">)</span>
<span class="n">cat_name</span> <span class="o">=</span> <span class="n">ind2val</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">][</span><span class="n">cat_idx</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Category name: </span><span class="si">{</span><span class="n">cat_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Find the itemId that were click by user 5 in interaction 3:
itemId: [tensor(637590)]

Find the category index of that item in itemattr:
Category index: [135.]

Finally, find the category name by using ind2val:
Category name: REAL_ESTATE,,Oppland
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Print-some-statistics-about-the-dataset">Print some statistics about the dataset<a class="anchor-link" href="#Print-some-statistics-about-the-dataset"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ratio of no clicks: </span><span class="si">{</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average slate length: </span><span class="si">{</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;slate_lengths&#39;</span><span class="p">][</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;slate_lengths&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ratio of slates that are recommendations: </span><span class="si">{</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;interaction_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;interaction_type&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average number of interactions per user: </span><span class="si">{</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Ratio of no clicks: 0.24
Average slate length: 11.14
Ratio of slates that are recommendations: 0.303
Average number of interactions per user: 16.43
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Masking-of-train/test/val">Masking of train/test/val<a class="anchor-link" href="#Masking-of-train/test/val"> </a></h3><p>Each batch returns a dictionary of pytorch tensors with data, and contains the usual data fields described above.
In addition, it contains a <code>mask_type</code> tensor which explains whether each click belongs to <em>train</em>, <em>valid</em> or <em>test</em>.
It is of the same dimensionality as the click tensor (<code>num users * num interactions</code>).
This is because we want to return the full sequence of interactions so that e.g. the test set can use the first clicks of the user (which belongs to the training set) to build a user profile.
The mask is defined in the following way:</p>

<pre><code>mask2split = {
    0 : 'PAD',
    1 : 'train',
    2 : 'valid',
    3 : 'test'
}</code></pre>
<p>If the mask equals zero it means that the length of the user sequence was shorter than this index.
The modeler has to take care to not train on elements in the validation or test dataset.
Typically this can be done by masking all losses that does not originate from the training dataset:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;mask_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train_mask</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[True, True, True,  ..., True, True, True],
        [True, True, True,  ..., True, True, True],
        [True, True, True,  ..., True, True, True],
        ...,
        [True, True, True,  ..., True, True, True],
        [True, True, True,  ..., True, True, True],
        [True, True, True,  ..., True, True, True]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For example, for user number 1 in this batch, the first five interactions belong to the training set, and the remaining belongs to the validation set.
We can extract the clicks that belong to the training set by using <code>mask_type</code>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mask of user 2:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;mask_type&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clicks belonging to the training set:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">,])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select only the clicks in training dataset:&quot;</span><span class="p">)</span>
<span class="n">batch</span><span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,][</span><span class="n">train_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">,]]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Mask of user 2:
tensor([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1])
 
Clicks belonging to the training set:
tensor([True, True, True, True, True, True, True, True, True, True, True, True,
        True, True, True, True, True, True, True, True])
 
Select only the clicks in training dataset:
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([ 246058,  522114,  688321,       1,       1,  492102,  342033, 1050842,
              1,       1,  878114, 1104893,  581533,       1, 1114863,  191381,
         493192,  736750,  693049,  493709])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

